---  
import dayjs from "@utils/dayjs";  
import { USER_NAME, DATE_FORMAT, t, umamiConfig } from "@config";  
import type { PostData } from "@interfaces/data";  
import { Icon } from "astro-icon/components";  

const { title, url, pubDate, badge, categories = [], tags = [], word, time } = Astro.props as PostData;  
const displayDate = pubDate ? dayjs(pubDate).format(DATE_FORMAT) : "";  

// ä» URL ä¸­æå– slug  
const slug = url ? url.toString().split('/').filter(Boolean).pop() : undefined;

const socialLinks = [  
  {  
    name: "å¾®åš",  
    icon: "ri:weibo-line",  
    class: "bg-[#E6162D] hover:bg-[#c5122a]",  
    type: "weibo",  
  },  
  {  
    name: "QQ",  
    icon: "ri:qq-line",  
    class: "bg-[#12B7F5] hover:bg-[#0b9ed8]",  
    type: "qq",  
  },  
  {  
    name: "å¾®ä¿¡",  
    icon: "ri:wechat-line",  
    class: "bg-[#07C160] hover:bg-[#06ad57]",  
  },  
  {  
    name: "Email",  
    icon: "ri:mail-line",  
    class: "bg-gray-600 hover:bg-gray-700",  
    type: "email",  
  },  
  {  
    name: "é“¾æ¥",  
    icon: "ri:links-line",  
    class: "bg-blue-600 hover:bg-blue-700",  
    type: "copy",  
  },  
];  
---  

<hr />  
<div class="container p-0" data-pagefind-ignore>  
  <div class="text-right text-sm text-base-content/60 italic mb-2">  
    <Icon name="ri:heart-line" class="w-4 h-4 inline-block align-text-bottom text-error" /> Thanks for reading!  
  </div>  

  <div class="card bg-base-200 overflow-visible">  
    <div class="card-body relative p-4 sm:p-6 lg:p-8">  
      <!-- License Icon -->  
      <div class="absolute -top-8 left-8">  
        <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center shadow-lg">  
          <Icon name="ri:creative-commons-line" class="w-10 h-10 text-primary-content" />  
        </div>  
      </div>  

      <!-- Article Metadata -->  
      <div class="space-y-4">  
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">{title}</h3>  

        <!-- Stats Row -->  
        <div class="flex flex-wrap gap-2 sm:gap-4 text-xs sm:text-sm opacity-75">  
          {displayDate && (  
            <span class="flex items-center gap-1">  
              <Icon name="lucide:calendar" class="h-4 w-4" />  
              {displayDate}  
            </span>  
          )}  

          {badge && (  
            <span class="flex items-center gap-1">  
              <Icon name="lucide:bookmark" class="h-4 w-4" />  
              {badge}  
            </span>  
          )}  

          {word && time && (  
            <div class="flex items-center gap-1">  
              <Icon name="lucide:book-open" class="h-4 w-4" />  
              <span>{word} {t("label.wordCount")} Â· {time} {t("label.readTime")}</span>  
            </div>  
          )}  

          <!-- æµè§ˆé‡æ˜¾ç¤º -->  
          {slug && (  
            <div class="flex items-center gap-1">  
              <Icon name="lucide:eye" class="h-4 w-4" />  
              <span id="license-page-views">åŠ è½½ä¸­...</span>  
            </div>  
          )}   

          <!-- å¤åˆ¶URLæŒ‰é’® -->
          <button id="copy-url-button" class="flex items-center gap-1 hover:text-primary transition-colors cursor-pointer">
            <Icon name="ri:links-line" class="w-4 h-4" />
          </button>
        </div>  

        <!-- License Info -->  
        <div class="mt-4">  
          <hr class="my-4" />  
          <div class="flex justify-between items-center flex-wrap gap-4">  
            <div class="text-sm opacity-75">  
              Â© {USER_NAME} |
              <a  
                href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed"  
                target="_blank"  
                rel="noopener noreferrer"  
                class="hover:text-primary transition-colors"  
              >  
                CC BY-NC-SA 4.0  
              </a>  
            </div>  

            <!-- Buttons Container -->
            <div class="flex gap-2">
              <!-- Support Button -->
              <button id="donate_button" class="btn btn-accent text-white" onmouseenter="donate_modal.showModal()">
                æ‰“èµä½œè€…
              </button>
              
              <button class="btn btn-primary btn-outline" onclick="share_modal.showModal()">  
                {t("label.share")}  
                <Icon name="ri:share-line" class="w-5 h-5" />  
              </button>  
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Donate Modal -->  
<dialog id="donate_modal" class="modal modal-bottom sm:modal-middle" data-pagefind-ignore>
  <div class="modal-box max-w-md rounded-none sm:rounded-xl p-4">
    <h3 class="font-bold text-lg sm:text-xl mb-2 text-center">
      ğŸ‰ æ„Ÿè°¢ä½ çš„æ”¯æŒï¼
    </h3>
    <!-- è¿™é‡Œæ”¾ç½®æ‰“èµå›¾ç‰‡ï¼Œæ‚¨éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„å›¾ç‰‡è·¯å¾„ -->
    <div class="flex justify-center mb-0">
      <img src="/donate.webp" alt="æ‰“èµäºŒç»´ç " class="max-w-[90%] max-h-[250px] h-auto rounded-lg object-contain" />
    </div>
    <div class="modal-action mt-2">
      <form method="dialog">
        <button class="btn btn-ghost hover:scale-105 transition-transform">
          {t("label.close")}
        </button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>{t("label.close")}</button>
  </form>
</dialog>

<!-- Share Modal -->  
<dialog id="share_modal" class="modal modal-bottom sm:modal-middle" data-pagefind-ignore>
  <div class="modal-box max-w-2xl rounded-none sm:rounded-xl">  
    <h3 class="font-bold text-lg sm:text-xl mb-6 text-center">  
      {t("label.shareCard")}  
    </h3>  
    <div class="flex flex-wrap gap-4 justify-center">  
      {  
        socialLinks.map(({ name, icon, class: bgClass, type }) => {
          // ä¸ºæ¯ä¸ªé“¾æ¥åˆ›å»ºé€šç”¨å±æ€§
          const commonProps = {
            class: `btn btn-circle btn-lg transition-transform hover:scale-110 ${bgClass}`,
            title: name
          };

          if (name === "å¾®ä¿¡") {
            return (
              <button 
                {...commonProps}
                onclick="wechat_qr_modal.showModal()"
              >  
                <span class="sr-only">{name}</span>  
                <Icon name={icon} class="w-6 h-6 text-white" />  
              </button>
            );
          } else if (type === "copy") {
            return (
              <button 
                {...commonProps}
                id="share-copy-url-button"
              >  
                <span class="sr-only">{name}</span>  
                <Icon name={icon} class="w-6 h-6 text-white" />  
              </button>
            );
          }
          
          // ä½¿ç”¨data-å±æ€§å­˜å‚¨åˆ†äº«å¹³å°ç±»å‹ï¼Œç”±JavaScriptå¤„ç†å…·ä½“é“¾æ¥
          return (
            <button 
              {...commonProps}
              data-share-type={type}
              class={`${commonProps.class} share-button`}
            >  
              <span class="sr-only">{name}</span>  
              <Icon name={icon} class="w-6 h-6 text-white" />  
            </button>
          );
        })  
      }  
    </div>  
    <div class="modal-action">  
      <form method="dialog">  
        <button class="btn btn-ghost hover:scale-105 transition-transform">  
          {t("label.close")}  
        </button>  
      </form>  
    </div>  
  </div>  
  <form method="dialog" class="modal-backdrop">  
    <button>{t("label.close")}</button>  
  </form>
</dialog>
  
<!-- WeChat QR Code Modal -->
<dialog id="wechat_qr_modal" class="modal modal-bottom sm:modal-middle" data-pagefind-ignore>
  <div class="modal-box w-full max-w-xs rounded-none sm:rounded-xl p-6 bg-white">  
    <div class="text-center">
      <div class="mb-4 text-green-500">
        <Icon name="mdi:wechat" class="w-12 h-12 mx-auto" />
      </div>
      <div class="bg-white rounded-lg shadow-lg mb-4 mx-auto p-4" style="display: flex; justify-content: center; align-items: center; width: 204px; height: 204px;">
        <img 
          src="https://api.qrserver.com/v1/create-qr-code/?size=196x196&margin=4" 
          alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç "
          class="max-w-full h-auto"
          id="wechat-qr-code"
        />
      </div>
      <p class="text-lg text-black dark:text-white break-words">æ‰‹æœºå¾®ä¿¡æ‰«æäºŒç»´ç ï¼Œç‚¹å‡»å³ä¸Šè§’Â·Â·Â·æŒ‰é’®åˆ†äº«</p>
    </div>
    <div class="modal-action mt-4">  
      <form method="dialog">  
        <button class="btn btn-primary">  
          {t("label.close")}  
        </button>  
      </form>  
    </div>  
  </div>  
  <form method="dialog" class="modal-backdrop">  
    <button>{t("label.close")}</button>  
  </form>
</dialog>

<!-- å¤åˆ¶æˆåŠŸæç¤º -->
<div id="copy-toast" class="fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg text-sm opacity-0 transition-opacity duration-300 pointer-events-none z-50" data-pagefind-ignore>
  å·²å¤åˆ¶é“¾æ¥
</div>

<script define:vars={{ slug, umamiConfig, title }} is:inline>
  // å¤åˆ¶URLåŠŸèƒ½
  const copyButtons = [
    document.getElementById('copy-url-button'),
    document.getElementById('share-copy-url-button')
  ];
  const copyToast = document.getElementById('copy-toast');
  const shareButtons = document.querySelectorAll('.share-button');
  const wechatQrCode = document.getElementById('wechat-qr-code');
  
  // å¤åˆ¶URLçš„å‡½æ•°ï¼Œä¾›å¤šä¸ªæŒ‰é’®è°ƒç”¨
  function copyCurrentUrl() {
    const currentUrl = window.location.href;
    
    // å¤åˆ¶URLåˆ°å‰ªè´´æ¿
    navigator.clipboard.writeText(currentUrl)
      .then(() => showCopyToast())
      .catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        fallbackCopyTextToClipboard(currentUrl);
      });
  }
  
  // åˆ†äº«æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
  function handleShareClick(event) {
    const button = event.target.closest('.share-button');
    if (!button) return;
    
    const shareType = button.dataset.shareType;
    const currentUrl = window.location.href;
    const shareTitle = encodeURIComponent(title || '');
    const encodedUrl = encodeURIComponent(currentUrl);
    
    let shareUrl;
    
    switch (shareType) {
      case 'weibo':
        shareUrl = `https://service.weibo.com/share/share.php?title=${shareTitle}&url=${encodedUrl}`;
        break;
      case 'qq':
        shareUrl = `https://connect.qq.com/widget/shareqq/index.html?title=${shareTitle}&url=${encodedUrl}`;
        break;
      case 'email':
        shareUrl = `mailto:?subject=${shareTitle}&body=${encodedUrl}`;
        break;
      default:
        return;
    }
    
    window.open(shareUrl, '_blank', 'noopener,noreferrer');
  }
  
  // ç”Ÿæˆå¾®ä¿¡åˆ†äº«äºŒç»´ç 
  function generateWechatQrCode() {
    if (!wechatQrCode) return;
    
    const currentUrl = window.location.href;
    const encodedUrl = encodeURIComponent(currentUrl);
    wechatQrCode.src = `https://api.qrserver.com/v1/create-qr-code/?size=196x196&margin=4&data=${encodedUrl}`;
  }
  
  // ä¸ºåˆ†äº«æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
  shareButtons.forEach(button => {
    button.addEventListener('click', handleShareClick);
  });
  
  // é¡µé¢åŠ è½½æ—¶ç”Ÿæˆå¾®ä¿¡äºŒç»´ç 
  generateWechatQrCode();
  
  // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
  function showCopyToast() {
    if (!copyToast) return;
    
    copyToast.classList.remove('opacity-0');
    copyToast.classList.add('opacity-100');
    
    // 2ç§’åéšè—æç¤º
    setTimeout(() => {
      if (copyToast) {
        copyToast.classList.remove('opacity-100');
        copyToast.classList.add('opacity-0');
      }
    }, 2000);
  }
  
  // ä¸ºæ‰€æœ‰å¤åˆ¶æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
  copyButtons.forEach(button => {
    if (button) {
      button.addEventListener('click', copyCurrentUrl);
    }
  });
  
  // å‰ªè´´æ¿APIå¤‡ç”¨æ–¹æ³•
  function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) showCopyToast();
    } catch (err) {
      console.error('å¤åˆ¶å¤±è´¥ (å¤‡ç”¨æ–¹æ³•):', err);
    }
    
    document.body.removeChild(textArea);
  }
  
  // è·å–æµè§ˆé‡ç»Ÿè®¡  
  async function fetchPageViews() {
    if (!slug || !umamiConfig.enable) return;
        
    try {
      // è·å–ç½‘ç«™IDå’Œtoken  
      const shareData = await fetch(`${umamiConfig.baseUrl}/api/share/${umamiConfig.shareId}`)
        .then(res => res.ok ? res.json() : Promise.reject('è·å–åˆ†äº«ä¿¡æ¯å¤±è´¥'));
          
      const { websiteId, token } = shareData;
      
      // è·å–ç»Ÿè®¡æ•°æ®  
      const currentTimestamp = Date.now();  
      const statsUrl = `${umamiConfig.baseUrl}/api/websites/${websiteId}/stats?startAt=0&endAt=${currentTimestamp}&unit=hour&timezone=${encodeURIComponent(umamiConfig.timezone)}&url=%2Fblog%2F${slug}&compare=false`;
          
      const statsData = await fetch(statsUrl, {
        headers: { 'x-umami-share-token': token }
      })
      .then(res => res.ok ? res.json() : Promise.reject('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥'));
          
      const pageViews = statsData.pageviews?.value || 0;
      const visits = statsData.visits?.value || 0;
      
      const displayElement = document.getElementById('license-page-views');
      if (displayElement) {
        displayElement.textContent = `æµè§ˆé‡ ${pageViews} Â· è®¿é—®æ•° ${visits}`;
      }
    } catch (error) {
      console.error('Error fetching page views:', error);
      const displayElement = document.getElementById('license-page-views');
      if (displayElement) {
        displayElement.textContent = 'ç»Ÿè®¡ä¸å¯ç”¨';
      }
    }
  }

  // è·å–æµè§ˆé‡ç»Ÿè®¡
  fetchPageViews();
</script>  

<style>  
  .modal-backdrop button {  
    cursor: default;  
    width: 100%;  
    height: 100%;  
    opacity: 0;  
  }  

  /* Remove underlines from PostFilter buttons */  
  :global(.card-body .btn-category),  
  :global(.card-body .btn-tag) {  
    text-decoration: none;  
  }  
</style>