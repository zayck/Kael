---  
import dayjs from "@utils/dayjs";  
import { USER_NAME, DATE_FORMAT, t, umamiConfig } from "@config";  
import type { PostData } from "@interfaces/data";  
import { Icon } from "astro-icon/components";  
import PostFilter from "./PostFilter.astro";  

const { title, url, pubDate, badge, categories = [], tags = [], word, time } = Astro.props as PostData;  
const displayDate = pubDate ? dayjs(pubDate).format(DATE_FORMAT) : "";  

// ä» URL ä¸­æå– slug  
const slug = url ? url.toString().split('/').filter(Boolean).pop() : undefined;  

// è·å–æ–‡ç« çš„ä¸»è¦åˆ†ç±»å¹¶è½¬æ¢ä¸ºå°å†™
const mainCategory = categories && categories.length > 0 ? categories[0].toLowerCase() : '';

// ç”Ÿæˆå®Œæ•´çš„URL
const getFullUrl = () => {
  if (!url) return '';
  return url.includes('/blog/') ? url : `https://zayck.pages.dev/blog/${mainCategory}/${slug}`;
};

const socialLinks = [  
  {  
    name: "å¾®åš",  
    icon: "ri:weibo-line",  
    class: "bg-[#E6162D] hover:bg-[#c5122a]",  
    url: `https://service.weibo.com/share/share.php?title=${title}&url=${getFullUrl()}`,  
  },  
  {  
    name: "QQ",  
    icon: "ri:qq-line",  
    class: "bg-[#12B7F5] hover:bg-[#0b9ed8]",  
    url: `https://connect.qq.com/widget/shareqq/index.html?title=${title}&url=${getFullUrl()}`,  
  },  
  {  
    name: "å¾®ä¿¡",  
    icon: "ri:wechat-line",  
    class: "bg-[#07C160] hover:bg-[#06ad57]",  
  },  
  {  
    name: "Email",  
    icon: "ri:mail-line",  
    class: "bg-gray-600 hover:bg-gray-700",  
    url: `mailto:?subject=${title}&body=${getFullUrl()}`,  
  },  
  {  
    name: "é“¾æ¥",  
    icon: "ri:links-line",  
    class: "bg-blue-600 hover:bg-blue-700",  
    type: "copy",  
  },  
];  
---  

<hr />  
<div class="container p-0" data-pagefind-ignore>  
  <div class="text-right text-sm text-base-content/60 italic mb-2">  
    <Icon name="ri:heart-line" class="w-4 h-4 inline-block align-text-bottom text-error" /> Thanks for reading!  
  </div>  

  <div class="card bg-base-200 overflow-visible">  
    <div class="card-body relative p-4 sm:p-6 lg:p-8">  
      <!-- License Icon -->  
      <div class="absolute -top-8 left-8">  
        <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center shadow-lg">  
          <Icon name="ri:creative-commons-line" class="w-10 h-10 text-primary-content" />  
        </div>  
      </div>  

      <!-- Article Metadata -->  
      <div class="space-y-4">  
        <h3 class="text-lg sm:text-xl lg:text-2xl font-bold">{title}</h3>  

        <!-- Stats Row -->  
        <div class="flex flex-wrap gap-2 sm:gap-4 text-xs sm:text-sm opacity-75">  
          {displayDate && (  
            <span class="flex items-center gap-1">  
              <Icon name="lucide:calendar" class="h-4 w-4" />  
              {displayDate}  
            </span>  
          )}  

          {badge && (  
            <span class="flex items-center gap-1">  
              <Icon name="lucide:bookmark" class="h-4 w-4" />  
              {badge}  
            </span>  
          )}  

          {word && time && (  
            <div class="flex items-center gap-1">  
              <Icon name="lucide:book-open" class="h-4 w-4" />  
              <span>{word} {t("label.wordCount")} Â· {time} {t("label.readTime")}</span>  
            </div>  
          )}  

          <!-- æµè§ˆé‡æ˜¾ç¤º -->  
          {slug && (  
            <div class="flex items-center gap-1">  
              <Icon name="lucide:eye" class="h-4 w-4" />  
              <span id="license-page-views">åŠ è½½ä¸­...</span>  
            </div>  
          )}   

          <!-- å¤åˆ¶URLæŒ‰é’® -->
          <button id="copy-url-button" class="flex items-center gap-1 hover:text-primary transition-colors cursor-pointer">
            <Icon name="ri:links-line" class="w-4 h-4" />
          </button>
        </div>  

        <!-- Categories and Tags -->  
        <div class="mt-4">  
          <PostFilter categories={categories} tags={tags} />  
          <!-- License Info -->  
          <hr class="my-4" />  
          <div class="flex justify-between items-center flex-wrap gap-4">  
            <div class="text-sm opacity-75">  
              Â© {USER_NAME} |
              <a  
                href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed"  
                target="_blank"  
                rel="noopener noreferrer"  
                class="hover:text-primary transition-colors"  
              >  
                CC BY-NC-SA 4.0  
              </a>  
            </div>  

            <!-- Buttons Container -->
            <div class="flex gap-2">
              <!-- Support Button -->
              <button id="donate_button" class="btn btn-accent text-white" onmouseenter="donate_modal.showModal()">
                æ‰“èµä½œè€…
              </button>
              
              <button class="btn btn-primary btn-outline" onclick="share_modal.showModal()">  
                {t("label.share")}  
                <Icon name="ri:share-line" class="w-5 h-5" />  
              </button>  
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Donate Modal -->  
<dialog id="donate_modal" class="modal modal-bottom sm:modal-middle" data-pagefind-ignore>
  <div class="modal-box max-w-md rounded-none sm:rounded-xl p-4">
    <h3 class="font-bold text-lg sm:text-xl mb-2 text-center">
      ğŸ‰ æ„Ÿè°¢ä½ çš„æ”¯æŒï¼
    </h3>
    <!-- è¿™é‡Œæ”¾ç½®æ‰“èµå›¾ç‰‡ï¼Œæ‚¨éœ€è¦æ›¿æ¢ä¸ºå®é™…çš„å›¾ç‰‡è·¯å¾„ -->
    <div class="flex justify-center mb-0">
      <img src="/donate.webp" alt="æ‰“èµäºŒç»´ç " class="max-w-[90%] max-h-[250px] h-auto rounded-lg object-contain" />
    </div>
    <div class="modal-action mt-2">
      <form method="dialog">
        <button class="btn btn-ghost hover:scale-105 transition-transform">
          {t("label.close")}
        </button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>{t("label.close")}</button>
  </form>
</dialog>

<!-- Share Modal -->  
<dialog id="share_modal" class="modal modal-bottom sm:modal-middle" data-pagefind-ignore>
  <div class="modal-box max-w-2xl rounded-none sm:rounded-xl">  
    <h3 class="font-bold text-lg sm:text-xl mb-6 text-center">  
      {t("label.shareCard")}  
    </h3>  
    <div class="flex flex-wrap gap-4 justify-center">  
      {  
        socialLinks.map(({ name, icon, class: bgClass, url, type }) => {
          // ä¸ºæ¯ä¸ªé“¾æ¥åˆ›å»ºé€šç”¨å±æ€§
          const commonProps = {
            class: `btn btn-circle btn-lg transition-transform hover:scale-110 ${bgClass}`,
            title: name
          };

          if (name === "å¾®ä¿¡") {
            return (
              <button 
                {...commonProps}
                onclick="wechat_qr_modal.showModal()"
              >  
                <span class="sr-only">{name}</span>  
                <Icon name={icon} class="w-6 h-6 text-white" />  
              </button>
            );
          } else if (type === "copy") {
            return (
              <button 
                id="share-copy-url-button"
                {...commonProps}
              >  
                <span class="sr-only">{name}</span>  
                <Icon name={icon} class="w-6 h-6 text-white" />  
              </button>
            );
          }
          
          return (
            <a  
              href={url}  
              {...commonProps}
              target="_blank"  
              rel="noopener noreferrer"  
            >  
              <span class="sr-only">{name}</span>  
              <Icon name={icon} class="w-6 h-6 text-white" />  
            </a>
          );
        })  
      }  
    </div>  
    <div class="modal-action">  
      <form method="dialog">  
        <button class="btn btn-ghost hover:scale-105 transition-transform">  
          {t("label.close")}  
        </button>  
      </form>  
    </div>  
  </div>  
  <form method="dialog" class="modal-backdrop">  
    <button>{t("label.close")}</button>  
  </form>
</dialog>
  
<!-- WeChat QR Code Modal -->
<dialog id="wechat_qr_modal" class="modal modal-bottom sm:modal-middle" data-pagefind-ignore>
  <div class="modal-box w-full max-w-xs rounded-none sm:rounded-xl p-6 bg-white">  
    <div class="text-center">
      <div class="mb-4 text-green-500">
        <Icon name="mdi:wechat" class="w-12 h-12 mx-auto" />
      </div>
      <div class="bg-white rounded-lg shadow-lg mb-4 mx-auto p-4" style="display: flex; justify-content: center; align-items: center; width: 204px; height: 204px;">
        <img 
          src={`https://api.qrserver.com/v1/create-qr-code/?size=196x196&margin=4&data=${encodeURIComponent(getFullUrl())}`} 
          alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç "
          class="max-w-full h-auto"
        />
      </div>
      <p class="text-lg text-black dark:text-white break-words">æ‰‹æœºå¾®ä¿¡æ‰«æäºŒç»´ç ï¼Œç‚¹å‡»å³ä¸Šè§’Â·Â·Â·æŒ‰é’®åˆ†äº«</p>
    </div>
    <div class="modal-action mt-4">  
      <form method="dialog">  
        <button class="btn btn-primary">  
          {t("label.close")}  
        </button>  
      </form>  
    </div>  
  </div>  
  <form method="dialog" class="modal-backdrop">  
    <button>{t("label.close")}</button>  
  </form>
</dialog>

<!-- å¤åˆ¶æˆåŠŸæç¤º -->
<div id="copy-toast" class="fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg text-sm opacity-0 transition-opacity duration-300 pointer-events-none z-50" data-pagefind-ignore>
  å·²å¤åˆ¶é“¾æ¥
</div>

<script define:vars={{ slug, umamiConfig }} is:inline>
  // ç›´æ¥åœ¨ç»„ä»¶ä¸­å®šä¹‰äº‹ä»¶ç›‘å¬å™¨ï¼Œä¸éœ€è¦å¤æ‚çš„DOMåŠ è½½æ£€æµ‹
  // å› ä¸ºç»„ä»¶ä½¿ç”¨äº†client:loadæŒ‡ä»¤ï¼Œè„šæœ¬ä¼šåœ¨ç»„ä»¶åŠ è½½æ—¶æ‰§è¡Œ
  
  // ç®€åŒ–çš„æ‰“èµæŒ‰é’®äº¤äº’é€»è¾‘
  const donateModal = document.getElementById('donate_modal');
  if (donateModal) {
    // åªä¿ç•™é€šè¿‡æŒ‰é’®ç‚¹å‡»å’ŒèƒŒæ™¯ç‚¹å‡»å…³é—­æ¨¡æ€æ¡†çš„åŠŸèƒ½
    donateModal.onmouseleave = null;
  }
  
  // å¤åˆ¶URLåŠŸèƒ½
  const copyButtons = [
    document.getElementById('copy-url-button'),
    document.getElementById('share-copy-url-button')
  ];
  const copyToast = document.getElementById('copy-toast');
  
  // å¤åˆ¶URLçš„å‡½æ•°ï¼Œä¾›å¤šä¸ªæŒ‰é’®è°ƒç”¨
  function copyCurrentUrl() {
    // è·å–å½“å‰é¡µé¢URL
    const currentUrl = window.location.href;
    
    // å¤åˆ¶URLåˆ°å‰ªè´´æ¿
    navigator.clipboard.writeText(currentUrl)
      .then(() => {
        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        if (copyToast) {
          copyToast.classList.remove('opacity-0');
          copyToast.classList.add('opacity-100');
          
          // 2ç§’åéšè—æç¤º
          setTimeout(() => {
            if (copyToast) {
              copyToast.classList.remove('opacity-100');
              copyToast.classList.add('opacity-0');
            }
          }, 2000);
        }
      })
      .catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        // å¦‚æœå‰ªè´´æ¿APIä¸å¯ç”¨ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•
        fallbackCopyTextToClipboard(currentUrl);
      });
  }
  
  // ä¸ºæ‰€æœ‰å¤åˆ¶æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
  copyButtons.forEach(button => {
    if (button) {
      button.addEventListener('click', copyCurrentUrl);
    }
  });
  
  // å‰ªè´´æ¿APIå¤‡ç”¨æ–¹æ³•
  function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful && copyToast) {
        copyToast.classList.remove('opacity-0');
        copyToast.classList.add('opacity-100');
        
        setTimeout(() => {
          if (copyToast) {
            copyToast.classList.remove('opacity-100');
            copyToast.classList.add('opacity-0');
          }
        }, 2000);
      }
    } catch (err) {
      console.error('å¤åˆ¶å¤±è´¥ (å¤‡ç”¨æ–¹æ³•):', err);
    }
    
    document.body.removeChild(textArea);
  }
  
  // è·å–æµè§ˆé‡ç»Ÿè®¡  
  async function fetchPageViews() {
    if (!slug || !umamiConfig.enable) return;  
        
    try {  
      // è·å–ç½‘ç«™IDå’Œtoken  
      const shareData = await fetch(`${umamiConfig.baseUrl}/api/share/${umamiConfig.shareId}`)
        .then(res => {
          if (!res.ok) throw new Error('è·å–åˆ†äº«ä¿¡æ¯å¤±è´¥');
          return res.json();
        });
          
      const { websiteId, token } = shareData;  
          
      // è·å–ç»Ÿè®¡æ•°æ®  
      const currentTimestamp = Date.now();  
      const statsUrl = `${umamiConfig.baseUrl}/api/websites/${websiteId}/stats?startAt=0&endAt=${currentTimestamp}&unit=hour&timezone=${encodeURIComponent(umamiConfig.timezone)}&url=%2Fblog%2F${slug}&compare=false`;  
          
      const statsData = await fetch(statsUrl, {  
        headers: { 'x-umami-share-token': token }  
      })
      .then(res => {
        if (!res.ok) throw new Error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');
        return res.json();
      });
          
      const pageViews = statsData.pageviews?.value || 0;  
      const visits = statsData.visits?.value || 0;  
          
      const displayElement = document.getElementById('license-page-views');  
      if (displayElement) {  
        displayElement.textContent = `æµè§ˆé‡ ${pageViews} Â· è®¿é—®æ•° ${visits}`;  
      }  
    } catch (error) {  
      console.error('Error fetching page views:', error);  
      const displayElement = document.getElementById('license-page-views');  
      if (displayElement) {  
        displayElement.textContent = 'ç»Ÿè®¡ä¸å¯ç”¨';  
      }  
    }  
  }

  // é¡µé¢åŠ è½½å®Œæˆåè·å–ç»Ÿè®¡æ•°æ®  
  if (document.readyState === 'loading') {  
    document.addEventListener('DOMContentLoaded', fetchPageViews);  
  } else {  
    fetchPageViews();  
  }
</script>  

<style>  
  .modal-backdrop button {  
    cursor: default;  
    width: 100%;  
    height: 100%;  
    opacity: 0;  
  }  

  /* Remove underlines from PostFilter buttons */  
  :global(.card-body .btn-category),  
  :global(.card-body .btn-tag) {  
    text-decoration: none;  
  }  
</style>